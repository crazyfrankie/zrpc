/*
{"level":"info","ts":1742786093.1121166,"caller":"server/server.go:49","msg":"Starting server","host":"localhost:8082","worker_pool_size":32,"task_queue_size":10000,"simulated_delay":0,"cpu_cores":16}
{"level":"info","ts":1742786093.112253,"caller":"server/server.go:70","msg":"Server is ready to accept connections"}
{"level":"info","ts":1742786093.112272,"caller":"server/server.go:42","msg":"Starting pprof server","address":":6060"}
{"level":"info","ts":1742786163.555123,"caller":"server/server.go:85","msg":"Processed requests","count":1000000}
{"level":"info","ts":1742786163.7507236,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:59430"}
{"level":"info","ts":1742786163.7507596,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:59438"}
{"level":"info","ts":1742786163.750827,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53240"}
{"level":"info","ts":1742786163.750835,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53248"}
{"level":"info","ts":1742786163.7508726,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53250"}
{"level":"info","ts":1742786163.7508814,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53252"}
{"level":"info","ts":1742786163.7509272,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53278"}
{"level":"info","ts":1742786163.7509649,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53310"}
{"level":"info","ts":1742786163.7509694,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53326"}
{"level":"info","ts":1742786163.750928,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53262"}
{"level":"info","ts":1742786163.750991,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53334"}
{"level":"info","ts":1742786163.7509935,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53226"}
{"level":"info","ts":1742786163.7510202,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53348"}
{"level":"info","ts":1742786163.7510252,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53386"}
{"level":"info","ts":1742786163.7510352,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53400"}
{"level":"info","ts":1742786163.7510278,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53362"}
{"level":"info","ts":1742786163.7510567,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53378"}
{"level":"info","ts":1742786163.7510686,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53412"}
{"level":"info","ts":1742786163.7510686,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53404"}
{"level":"info","ts":1742786163.7510805,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53416"}
{"level":"info","ts":1742786163.7511678,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53534"}
{"level":"info","ts":1742786163.7511778,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53460"}
{"level":"info","ts":1742786163.7511892,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53538"}
{"level":"info","ts":1742786163.7512279,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53458"}
{"level":"info","ts":1742786163.751237,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53552"}
{"level":"info","ts":1742786163.7512372,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53430"}
{"level":"info","ts":1742786163.7512443,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53614"}
{"level":"info","ts":1742786163.7512777,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53630"}
{"level":"info","ts":1742786163.7512176,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53442"}
{"level":"info","ts":1742786163.7511644,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53294"}
{"level":"info","ts":1742786163.7512503,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53620"}
{"level":"info","ts":1742786163.7511947,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53462"}
{"level":"info","ts":1742786163.751202,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53474"}
{"level":"info","ts":1742786163.751563,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52784"}
{"level":"info","ts":1742786163.7512085,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53482"}
{"level":"info","ts":1742786163.7516174,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53146"}
{"level":"info","ts":1742786163.751611,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53124"}
{"level":"info","ts":1742786163.751652,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53200"}
{"level":"info","ts":1742786163.7516508,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52870"}
{"level":"info","ts":1742786163.7516787,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52832"}
{"level":"info","ts":1742786163.751688,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53060"}
{"level":"info","ts":1742786163.7516944,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52850"}
{"level":"info","ts":1742786163.751724,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53078"}
{"level":"info","ts":1742786163.7517326,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52986"}
{"level":"info","ts":1742786163.7517245,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52890"}
{"level":"info","ts":1742786163.751696,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52996"}
{"level":"info","ts":1742786163.751618,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52900"}
{"level":"info","ts":1742786163.7517002,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52924"}
{"level":"info","ts":1742786163.7516499,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53196"}
{"level":"info","ts":1742786163.7512171,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53494"}
{"level":"info","ts":1742786163.7512164,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53450"}
{"level":"info","ts":1742786163.7512228,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53456"}
{"level":"info","ts":1742786163.751221,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53518"}
{"level":"info","ts":1742786163.7512317,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53600"}
{"level":"info","ts":1742786163.751226,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53510"}
{"level":"info","ts":1742786163.7512536,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53566"}
{"level":"info","ts":1742786163.7512352,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53418"}
{"level":"info","ts":1742786163.7512577,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53576"}
{"level":"info","ts":1742786163.7512615,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53584"}
{"level":"info","ts":1742786163.7512565,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53616"}
{"level":"info","ts":1742786163.7512662,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53590"}
{"level":"info","ts":1742786163.7512622,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53604"}
{"level":"info","ts":1742786163.751267,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53612"}
{"level":"info","ts":1742786163.7512703,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53596"}
{"level":"info","ts":1742786163.7516022,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52808"}
{"level":"info","ts":1742786163.7516088,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53134"}
{"level":"info","ts":1742786163.751599,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52796"}
{"level":"info","ts":1742786163.7516136,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53142"}
{"level":"info","ts":1742786163.7516284,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52810"}
{"level":"info","ts":1742786163.7516315,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53158"}
{"level":"info","ts":1742786163.751637,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53160"}
{"level":"info","ts":1742786163.7512124,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53486"}
{"level":"info","ts":1742786163.751638,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52824"}
{"level":"info","ts":1742786163.751643,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53164"}
{"level":"info","ts":1742786163.751648,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53198"}
{"level":"info","ts":1742786163.7516541,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52990"}
{"level":"info","ts":1742786163.7516625,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53174"}
{"level":"info","ts":1742786163.7516642,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53210"}
{"level":"info","ts":1742786163.7516742,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52838"}
{"level":"info","ts":1742786163.7516713,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52902"}
{"level":"info","ts":1742786163.7516737,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53180"}
{"level":"info","ts":1742786163.7516828,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52912"}
{"level":"info","ts":1742786163.7516706,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52864"}
{"level":"info","ts":1742786163.751688,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53026"}
{"level":"info","ts":1742786163.7516925,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52922"}
{"level":"info","ts":1742786163.7516901,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53054"}
{"level":"info","ts":1742786163.751703,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53040"}
{"level":"info","ts":1742786163.7517033,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53012"}
{"level":"info","ts":1742786163.7517078,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52934"}
{"level":"info","ts":1742786163.751709,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53046"}
{"level":"info","ts":1742786163.7517104,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53064"}
{"level":"info","ts":1742786163.7517147,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52936"}
{"level":"info","ts":1742786163.7517142,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52858"}
{"level":"info","ts":1742786163.7517197,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52878"}
{"level":"info","ts":1742786163.7517228,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52946"}
{"level":"info","ts":1742786163.7517188,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53102"}
{"level":"info","ts":1742786163.7517211,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:53114"}
{"level":"info","ts":1742786163.7517235,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52872"}
{"level":"info","ts":1742786163.7517297,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52956"}
{"level":"info","ts":1742786163.751732,"caller":"zrpc/server.go:273","msg":"client has closed the connection:","addr":"127.0.0.1:52984"}
*/
package main

import (
	"context"
	"flag"
	"net/http"
	_ "net/http/pprof"
	"runtime"
	"sync"
	"sync/atomic"
	"time"

	"go.uber.org/zap"
	"go.uber.org/zap/zapcore"

	"github.com/crazyfrankie/zrpc"
	"github.com/crazyfrankie/zrpc/benchmark/bench"
)

var (
	host       = flag.String("host", "127.0.0.1:8082", "listened ip and port")
	cpuprofile = flag.String("cpuprofile", "", "write cpu profile to file")
	delay      = flag.Duration("delay", 0, "delay to mock business processing")
	workerNum  = flag.Int("worker_num", runtime.NumCPU()*4, "number of workers for request processing")
	taskQueue  = flag.Int("task_queue", 100000, "task queue size for worker pool")
	pprofPort  = flag.String("pprof", ":6060", "pprof http server address")
	logLevel   = flag.String("log", "info", "log level: debug, info, warn, error")
	bufferSize = flag.Int("buffer", 64*1024, "response buffer size")
)

// 对象池，用于复用响应对象
var responsePool = sync.Pool{
	New: func() interface{} {
		return &bench.BenchmarkMessage{
			Field1: "OK",
			Field2: 100,
		}
	},
}

func main() {
	// 设置最大线程数
	runtime.GOMAXPROCS(runtime.NumCPU())

	flag.Parse()

	// 配置日志
	logConfig := zap.NewProductionConfig()
	switch *logLevel {
	case "debug":
		logConfig.Level = zap.NewAtomicLevelAt(zapcore.DebugLevel)
	case "info":
		logConfig.Level = zap.NewAtomicLevelAt(zapcore.InfoLevel)
	case "warn":
		logConfig.Level = zap.NewAtomicLevelAt(zapcore.WarnLevel)
	case "error":
		logConfig.Level = zap.NewAtomicLevelAt(zapcore.ErrorLevel)
	}

	// 减少日志采样以提高性能
	logConfig.Sampling = &zap.SamplingConfig{
		Initial:    100,
		Thereafter: 100,
	}

	logger, _ := logConfig.Build()
	defer logger.Sync()
	zap.ReplaceGlobals(logger)

	// 启动pprof服务器，用于性能分析
	go func() {
		if *pprofPort != "" {
			logger.Info("Starting pprof server", zap.String("address", *pprofPort))
			if err := http.ListenAndServe(*pprofPort, nil); err != nil {
				logger.Error("Failed to start pprof server", zap.Error(err))
			}
		}
	}()

	logger.Info("Starting server",
		zap.String("host", *host),
		zap.Int("worker_pool_size", *workerNum),
		zap.Int("task_queue_size", *taskQueue),
		zap.Duration("simulated_delay", *delay),
		zap.Int("cpu_cores", runtime.NumCPU()),
		zap.Int("buffer_size", *bufferSize),
	)

	// 使用更多的Server选项
	srvOptions := []zrpc.ServerOption{
		zrpc.WithWorkerPool(*workerNum),
		zrpc.WithTaskQueueSize(*taskQueue),
		zrpc.WithReadTimeout(2 * time.Second),
		zrpc.WithWriteTimeout(2 * time.Second),
		zrpc.WithMaxReceiveMessageSize(1024 * 1024 * 10),
		zrpc.WithMaxSendMessageSize(1024 * 1024 * 10),
	}

	srv := zrpc.NewServer(srvOptions...)
	bench.RegisterHelloServiceServer(srv, &HelloService{})

	// 预热缓存
	logger.Info("Pre-warming response cache...")
	for i := 0; i < 1000; i++ {
		_ = responsePool.Get().(*bench.BenchmarkMessage)
	}

	logger.Info("Server is ready to accept connections")
	if err := srv.Serve("tcp", *host); err != nil {
		logger.Fatal("Server failed", zap.Error(err))
	}
}

type HelloService struct {
	bench.UnimplementedHelloServiceServer
	requestCount int64
}

func (s *HelloService) Say(ctx context.Context, req *bench.BenchmarkMessage) (*bench.BenchmarkMessage, error) {
	// 使用原子操作增加请求计数，每处理1000000个请求打印一条日志
	count := atomic.AddInt64(&s.requestCount, 1)
	if count%1000000 == 0 {
		zap.L().Info("Processed requests", zap.Int64("count", count))
	}

	// 确保请求对象不为空
	if req == nil {
		return &bench.BenchmarkMessage{Field1: "ERROR", Field2: 0}, nil
	}

	// 从对象池获取响应对象而不是创建新对象
	res := responsePool.Get().(*bench.BenchmarkMessage)

	// 复制必要字段
	if req.Field9 != "" {
		res.Field9 = req.Field9
	}
	if req.Field18 != "" {
		res.Field18 = req.Field18
	}
	res.Field80 = req.Field80
	res.Field81 = req.Field81
	res.Field3 = req.Field3
	res.Field280 = req.Field280
	res.Field6 = req.Field6
	res.Field22 = req.Field22

	// 仅在需要时复制更多字段
	if len(req.Field4) > 0 {
		res.Field4 = req.Field4
	}
	if len(req.Field5) > 0 {
		res.Field5 = req.Field5
	}
	res.Field59 = req.Field59

	if *delay > 0 {
		time.Sleep(*delay)
	} else {
		runtime.Gosched()
	}

	// 不再直接返回res，而是将其包装在defer函数中，确保在RPC调用完成后对象会被放回池中
	respCopy := *res
	// 将原对象放回池中
	responsePool.Put(res)

	// 返回复制出来的对象
	return &respCopy, nil
}
